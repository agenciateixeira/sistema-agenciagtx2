generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum PermissionRole {
  VIEWER
  EDITOR
  ADMIN
}

enum NotificationSeverity {
  LOW
  MEDIUM
  HIGH
}

enum NotificationChannel {
  IN_APP
  EMAIL
  WEBHOOK
}

enum ReportCadence {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum AbTestStatus {
  DRAFT
  RUNNING
  FINISHED
}

enum PredictiveIntensity {
  CONSERVADOR
  BALANCEADO
  AGRESSIVO
}

model User {
  id         String        @id @default(uuid())
  email      String        @unique
  password   String
  name       String?
  avatarUrl  String?
  role       PermissionRole @default(VIEWER)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  memberships        TeamMember[]
  notifications     Notification[]
  reportSchedules   ReportSchedule[]
  tutorialProgress  TutorialProgress[]
  onboardingEntries OnboardingProgress[]
  auditLogs         AuditLog[]
  chatMessages      ChatMessage[]
  abTests           AbTest[]        @relation("AbTestOwner")
  predictiveLabels  PredictiveLabel[]
}

model Team {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  logoUrl     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  intensity   PredictiveIntensity @default(BALANCEADO)

  members          TeamMember[]
  notifications    Notification[]
  reportTemplates  ReportTemplate[]
  tutorialCatalog  Tutorial[]
  onboardingSteps  OnboardingStep[]
  auditLogs        AuditLog[]
  predictiveEvents PredictiveSession[]
  abTests          AbTest[]        @relation("TeamAbTests")
  webhooks         WebhookEndpoint[]
  chatThreads      ChatThread[]
  tags             Tag[]
}

model TeamMember {
  id        String         @id @default(uuid())
  teamId    String
  userId    String
  role      PermissionRole @default(VIEWER)
  createdAt DateTime       @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model ReportTemplate {
  id         String   @id @default(uuid())
  teamId     String
  name       String
  description String?
  metrics    String[]
  filters    Json?
  createdAt  DateTime @default(now())

  team      Team             @relation(fields: [teamId], references: [id])
  schedules ReportSchedule[]
}

model ReportSchedule {
  id            String        @id @default(uuid())
  templateId    String
  ownerId       String
  cadence       ReportCadence
  cadenceCustom String?
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  channels      NotificationChannel[] @default([EMAIL])

  template ReportTemplate @relation(fields: [templateId], references: [id])
  owner    User           @relation(fields: [ownerId], references: [id])
  exports  ReportExport[]
}

model ReportExport {
  id           String         @id @default(uuid())
  scheduleId   String
  format       String
  storagePath  String
  deliveredTo  String[]
  deliveredAt  DateTime      @default(now())

  schedule ReportSchedule @relation(fields: [scheduleId], references: [id])
}

model Notification {
  id          String               @id @default(uuid())
  teamId      String
  userId      String?
  title       String
  message     String
  severity    NotificationSeverity @default(MEDIUM)
  channel     NotificationChannel  @default(IN_APP)
  metadata    Json?
  readAt      DateTime?
  createdAt   DateTime             @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User? @relation(fields: [userId], references: [id])
}

model Tutorial {
  id        String   @id @default(uuid())
  teamId    String
  title     String
  duration  Int
  category  String
  videoUrl  String?
  createdAt DateTime @default(now())

  team     Team                @relation(fields: [teamId], references: [id])
  progress TutorialProgress[]
}

model TutorialProgress {
  id         String   @id @default(uuid())
  tutorialId String
  userId     String
  status     String   @default("pendente")
  completedAt DateTime?

  tutorial Tutorial @relation(fields: [tutorialId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([tutorialId, userId])
}

model OnboardingStep {
  id        String   @id @default(uuid())
  teamId    String
  label     String
  order     Int
  createdAt DateTime @default(now())

  team      Team                 @relation(fields: [teamId], references: [id])
  progress  OnboardingProgress[]
}

model OnboardingProgress {
  id        String   @id @default(uuid())
  stepId    String
  userId    String
  completed Boolean  @default(false)
  completedAt DateTime?

  step OnboardingStep @relation(fields: [stepId], references: [id])
  user User           @relation(fields: [userId], references: [id])

  @@unique([stepId, userId])
}

model AuditLog {
  id        String   @id @default(uuid())
  teamId    String
  userId    String?
  event     String
  detail    String?
  payload   Json?
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([teamId, createdAt])
}

model PredictiveSession {
  id           String   @id @default(uuid())
  teamId       String
  sessionCode  String   @unique
  abandonmentScore Int
  status       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  team         Team                      @relation(fields: [teamId], references: [id])
  interventions PredictiveIntervention[]
  labels        PredictiveLabel[]
}

model PredictiveIntervention {
  id          String   @id @default(uuid())
  sessionId   String
  channel     String
  converted   Boolean  @default(false)
  respondedAt DateTime?

  session PredictiveSession @relation(fields: [sessionId], references: [id])
}

model PredictiveLabel {
  id        String   @id @default(uuid())
  sessionId String
  userId    String
  label     String
  createdAt DateTime @default(now())

  session PredictiveSession @relation(fields: [sessionId], references: [id])
  user    User              @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
}

model AbTest {
  id          String       @id @default(uuid())
  teamId      String
  ownerId     String
  name        String
  status      AbTestStatus @default(DRAFT)
  context     String
  createdAt   DateTime     @default(now())

  team     Team     @relation("TeamAbTests", fields: [teamId], references: [id])
  owner    User     @relation("AbTestOwner", fields: [ownerId], references: [id])
  variants AbTestVariant[]
}

model AbTestVariant {
  id        String @id @default(uuid())
  testId    String
  label     String
  conversionRate Float?
  responseTime   Int?
  content   Json?

  test AbTest @relation(fields: [testId], references: [id])
}

model WebhookEndpoint {
  id          String   @id @default(uuid())
  teamId      String
  name        String
  url         String
  secret      String?
  events      String[]
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  team      Team              @relation(fields: [teamId], references: [id])
  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id         String   @id @default(uuid())
  endpointId String
  status     String
  payload    Json
  deliveredAt DateTime @default(now())

  endpoint WebhookEndpoint @relation(fields: [endpointId], references: [id])
}

model ChatThread {
  id         String   @id @default(uuid())
  teamId     String
  customer   String
  status     String
  lastMessage String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  team     Team          @relation(fields: [teamId], references: [id])
  messages ChatMessage[]
  tags     ChatTag[]
}

model ChatMessage {
  id         String   @id @default(uuid())
  threadId   String
  userId     String?
  content    String
  direction  String
  createdAt  DateTime @default(now())

  thread ChatThread @relation(fields: [threadId], references: [id])
  user   User?      @relation(fields: [userId], references: [id])
}

model Tag {
  id     String @id @default(uuid())
  teamId String
  label  String
  color  String?

  team Team @relation(fields: [teamId], references: [id])
  chat ChatTag[]
}

model ChatTag {
  threadId String
  tagId    String

  thread ChatThread @relation(fields: [threadId], references: [id])
  tag    Tag        @relation(fields: [tagId], references: [id])

  @@id([threadId, tagId])
}
